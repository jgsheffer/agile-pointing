<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OhayoDev Pointing Poker - Material Design</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #121212;
            color: rgba(255, 255, 255, 0.87);
        }
        .card {
            background-color: #1e1e1e;
            border-radius: 4px;
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.2), 0 4px 5px 0 rgba(0,0,0,0.14), 0 1px 10px 0 rgba(0,0,0,0.12);
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        .emoji-option {
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            background-color: #2c2c2c;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .emoji-option:hover {
            background-color: #3700B3;
            box-shadow: 0 3px 5px -1px rgba(0,0,0,0.2), 0 6px 10px 0 rgba(0,0,0,0.14), 0 1px 18px 0 rgba(0,0,0,0.12);
        }
        .vote-button {
            width: 56px;
            height: 56px;
            font-size: 18px;
            transition: background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 3px 5px -1px rgba(0,0,0,0.2), 0 6px 10px 0 rgba(0,0,0,0.14), 0 1px 18px 0 rgba(0,0,0,0.12);
        }
        .vote-button:hover {
            box-shadow: 0 5px 5px -3px rgba(0,0,0,0.2), 0 8px 10px 1px rgba(0,0,0,0.14), 0 3px 14px 2px rgba(0,0,0,0.12);
        }
        .participant {
            transition: transform 0.3s;
        }
        .participant.voted {
            transform: scale(1.02);
        }
        .md-btn {
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 1.25px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .md-btn-primary {
            background-color: #BB86FC;
            color: #000;
        }
        .md-btn-primary:hover {
            background-color: #3700B3;
            color: #fff;
        }
        .md-btn-secondary {
            background-color: #03DAC6;
            color: #000;
        }
        .md-btn-secondary:hover {
            background-color: #018786;
            color: #fff;
        }
        .input-md {
            background-color: #2c2c2c;
            color: rgba(255, 255, 255, 0.87);
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.42);
            transition: border-bottom-color 0.3s;
        }
        .input-md:focus {
            border-bottom-color: #BB86FC;
            outline: none;
        }
        .input-md::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        @keyframes rainbow {
            0% { color: violet; }
            14% { color: indigo; }
            28% { color: blue; }
            42% { color: green; }
            57% { color: yellow; }
            71% { color: orange; }
            85% { color: red; }
            100% { color: violet; }
        }
        .rainbow-text {
            animation: rainbow 5s linear infinite;
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        #giphy-image {
            max-width: 100%;
            height: auto;
            margin-top: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div id="app" class="container mx-auto p-4">
        <div id="join-form" class="card p-6 max-w-md mx-auto">
            <h2 class="text-2xl font-medium mb-6 text-center">Join NetJets Pointing Poker</h2>
            <div class="mb-4">
                <input type="text" id="name" placeholder="Your Name" class="w-full p-2 mb-1 input-md">
                <div class="h-0.5 w-full bg-purple-500 transform scale-x-0 transition-transform duration-300 origin-left"></div>
            </div>
            <div class="mb-4">
                <input type="text" id="room" placeholder="Room ID" class="w-full p-2 mb-1 input-md">
                <div class="h-0.5 w-full bg-purple-500 transform scale-x-0 transition-transform duration-300 origin-left"></div>
            </div>
            <div class="mb-6">
                <p class="mb-2 text-sm font-medium">Choose your avatar:</p>
                <div id="emoji-grid" class="emoji-grid"></div>
            </div>
            <button onclick="joinRoom()" class="w-full md-btn md-btn-primary p-2 rounded">Join Room</button>
        </div>
        <div id="voting-area" class="hidden">
            <h2 class="text-2xl font-medium mb-6 text-center">Room: <span id="room-id"></span></h2>
            <div id="voting-buttons" class="flex justify-center space-x-2 mb-6">
                <button onclick="vote(1)" class="vote-button md-btn-primary rounded-full">1</button>
                <button onclick="vote(2)" class="vote-button md-btn-primary rounded-full">2</button>
                <button onclick="vote(3)" class="vote-button md-btn-primary rounded-full">3</button>
                <button onclick="vote(5)" class="vote-button md-btn-primary rounded-full">5</button>
                <button onclick="vote(8)" class="vote-button md-btn-primary rounded-full">8</button>
                <button onclick="vote(13)" class="vote-button md-btn-primary rounded-full">13</button>
            </div>
            <div class="flex justify-center space-x-4 mb-6">
                <button onclick="revealVotes()" class="md-btn md-btn-primary px-4 py-2 rounded">
                    <span class="material-icons mr-2">visibility</span>Reveal Votes
                </button>
                <button onclick="resetVotes()" class="md-btn md-btn-secondary px-4 py-2 rounded">
                    <span class="material-icons mr-2">refresh</span>Reset Votes
                </button>
                <button onclick="leaveRoom()" class="md-btn md-btn-danger px-4 py-2 rounded">
                    <span class="material-icons mr-2">exit_to_app</span>Leave Room
                </button>
            </div>
            <div id="results" class="mb-6 text-center hidden">
                <p class="text-xl">Average Vote: <span id="average-vote"></span></p>
                <div id="consensus" class="rainbow-text hidden">CONSENSUS</div>
                <img id="giphy-image" class="hidden mx-auto" alt="Let's talk">
            </div>
            <div id="participants" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRoom = '';
        let selectedEmoji = '';
        let sessionId = localStorage.getItem('sessionId');
        const emojis = ['😀', '😎', '🤓', '🦄', '🐱', '🐶', '🦊', '🐸', '🐼', '🐯'];
        const fibonacciSequence = [1, 2, 3, 5, 8, 13];

        const letsTalkGifs = [
            'https://i.giphy.com/tbEjpqYUbeGyZtIcES.webp',
            'https://i.giphy.com/01u3Rw1zQLSylw2Tn9.webp',
        ];

        function populateEmojiGrid() {
            const emojiGrid = document.getElementById('emoji-grid');
            emojis.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'emoji-option';
                div.textContent = emoji;
                div.onclick = () => selectEmoji(emoji);
                emojiGrid.appendChild(div);
            });
        }

        function selectEmoji(emoji) {
            selectedEmoji = emoji;
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.style.backgroundColor = el.textContent === emoji ? '#3700B3' : '#2c2c2c';
            });
        }

        populateEmojiGrid();

        function joinRoom() {
            const name = document.getElementById('name').value;
            const room = document.getElementById('room').value;
            if (name && room && selectedEmoji) {
                currentRoom = room;
                socket.emit('joinRoom', { room, name, avatar: selectedEmoji, sessionId });
                document.getElementById('join-form').classList.add('hidden');
                document.getElementById('voting-area').classList.remove('hidden');
                document.getElementById('room-id').textContent = room;
                localStorage.setItem('pokerSession', JSON.stringify({ name, room, avatar: selectedEmoji }));
            } else {
                alert('Please enter your name, room ID, and select an avatar.');
            }
        }

        function leaveRoom() {
            socket.emit('leaveRoom', { room: currentRoom, sessionId });
            currentRoom = '';
            document.getElementById('voting-area').classList.add('hidden');
            document.getElementById('join-form').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('consensus').classList.add('hidden');
            document.getElementById('giphy-image').classList.add('hidden');
            localStorage.removeItem('pokerSession');
        }

        function checkExistingSession() {
            const session = JSON.parse(localStorage.getItem('pokerSession'));
            if (session) {
                document.getElementById('name').value = session.name;
                document.getElementById('room').value = session.room;
                selectEmoji(session.avatar);
                joinRoom();
            }
        }

        // Check for existing session when the page loads
        window.onload = checkExistingSession;

        function vote(value) {
            socket.emit('vote', { room: currentRoom, vote: value, sessionId });
        }

        function revealVotes() {
            socket.emit('revealVotes', currentRoom);
        }

        function resetVotes() {
            socket.emit('resetVotes', currentRoom);
            document.getElementById('results').classList.add('hidden');
            document.getElementById('consensus').classList.add('hidden');
            document.getElementById('giphy-image').classList.add('hidden');
        }

        socket.on('sessionCreated', (newSessionId) => {
            sessionId = newSessionId;
            localStorage.setItem('sessionId', sessionId);
        });

        socket.on('updateParticipants', (participants) => {
            updateParticipantList(participants);
        });

        socket.on('updateVotes', (participants) => {
            updateParticipantList(participants);
        });

        socket.on('votesRevealed', (participants) => {
            updateParticipantList(participants, true);
            calculateAndDisplayResults(participants);
        });

        socket.on('votesReset', (participants) => {
            updateParticipantList(participants);
            document.getElementById('results').classList.add('hidden');
            document.getElementById('consensus').classList.add('hidden');
            document.getElementById('giphy-image').classList.add('hidden');
        });

        function updateParticipantList(participants, revealed = false) {
            const participantsDiv = document.getElementById('participants');
            participantsDiv.innerHTML = '';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'participant card p-4 flex items-center space-x-2';
                div.innerHTML = `
                    <span class="text-3xl">${p.avatar}</span>
                    <span class="font-medium">${p.name}</span>
                    <span class="ml-auto ${p.vote ? 'text-green-400' : 'text-gray-500'}">
                        ${revealed ? (p.vote || '-') : (p.vote ? '<span class="material-icons">check_circle</span>' : '<span class="material-icons">help_outline</span>')}
                    </span>
                `;
                if (p.vote) div.classList.add('voted');
                participantsDiv.appendChild(div);
            });
        }

        function calculateAndDisplayResults(participants) {
            const votes = participants.map(p => p.vote).filter(v => v !== null);
            const average = votes.length > 0 ? votes.reduce((a, b) => a + b, 0) / votes.length : 0;
            
            document.getElementById('average-vote').textContent = average.toFixed(2);
            document.getElementById('results').classList.remove('hidden');

            const allSame = votes.length > 0 && votes.every(v => v === votes[0]);
            if (allSame) {
                document.getElementById('consensus').classList.remove('hidden');
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } else {
                document.getElementById('consensus').classList.add('hidden');
            }

            const minVote = Math.min(...votes);
            const maxVote = Math.max(...votes);
            const minIndex = fibonacciSequence.indexOf(minVote);
            const maxIndex = fibonacciSequence.indexOf(maxVote);

            if (maxIndex - minIndex > 2) {
                displayRandomGif();
            } else {
                document.getElementById('giphy-image').classList.add('hidden');
            }
        }

        function displayRandomGif() {
            const randomIndex = Math.floor(Math.random() * letsTalkGifs.length);
            const gifUrl = letsTalkGifs[randomIndex];
            const giphyImage = document.getElementById('giphy-image');
            giphyImage.src = gifUrl;
            giphyImage.classList.remove('hidden');
        }

        // Add focus effect to input fields
        document.querySelectorAll('.input-md').forEach(input => {
            input.addEventListener('focus', () => {
                input.nextElementSibling.classList.remove('scale-x-0');
                input.nextElementSibling.classList.add('scale-x-100');
            });
            input.addEventListener('blur', () => {
                if (input.value === '') {
                    input.nextElementSibling.classList.remove('scale-x-100');
                    input.nextElementSibling.classList.add('scale-x-0');
                }
            });
        });
    </script>
</body>
</html>